# IO密集型应用优化实践

## 背景

这次的优化源于一个从企业微信同步外部联系人的需求，目前40多万外部联系人，计划是每天同步1次。
数据量看着不大，但是在完成第一版本的代码之后，发现一次同步完成需要20多个小时，这显然是无法接受的，遂开始优化，整个优化分成三个步骤。

## 限制

业务限制：只能全量同步，不能使用企业微信提供的事件通知进行增量同步（因为一些原因事件通知无法接入我们系统）

## 第一版本代码的缺陷

第一个版本是顺着企业微信提供的API来进行需求实现的：

1. 调用企业微信API先从企业微信查找哪些员工可以添加外部联系人
2. 调用企业微信API查找每一位员工所拥有的外部联系人ID
3. 根据员工的外部联系人ID调用企业微信API获取外部联系人的详情（包括外部联系人的基本信息、外部属性（网页、小程序等）、以及和企业员工的关系）(开始入库)

这个版本的缺陷主要有两个：

1. 从第3步才开始入库要，对同一个外部联系人的信息要进行多次重复比有没有变更，因为我们一个外部联系人可能会被很多个员工添加，所有重复比对的概率还是很大，到头来比对的次数远远不止40w次
2. 很多对数据库的操作都没有做批量操作，导致多次IO

## 第二个版本的优化

第二个版本的优化就是针对上面的缺陷进行优化：

1. 在步骤2进行入库， 这个过程耗时5分钟左右
2. 查找出外部联系人的ID（去重），然后执行第3步
3. 数据库操作改成批量操作

优化结果：同步一次大概10小时

## 进一步优化

这一步的优化是在第二步的基础上开启10个线程采用Fofk/Join框架同时入库每一个外部联系人的信息来进一步压缩执行时间

优化结果： 1小时，这个时间是可以接受的，停止优化
