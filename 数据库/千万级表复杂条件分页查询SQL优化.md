# 千万级表复杂条件分页查询SQL优化

## 背景

公司使用企业微信添加了大量的外部联系人，数据量大概在400w左右，我们把这些外部联系人基本信息、员工和外部联系人关系数据，以及员工给外部联系人的打标数据同步到了我们本地数据库，这分别对应数据库中的3张表。构成了一个1对n对n的数据结构，我们需要根据添加人和标签还有外部联系人的添加时间等条件进行分页查询，也就是查询条件会存在3张表中，并且需要去重。

## 索引是必不可少的

索引对查询的重要性不必多说了，如何优化索引不是这篇文章的主题，不再赘述

## 难以逾越的性能杀手count()

无条件的时候，可以把总数记在缓存或者单独使用一个表记录。
在有条件的查询中，count的时间消耗简直是一个无解的问题

统计总数，把数据查到内存中进行统计，但是会消耗内存
不查总数，使用上下页的方式

## 去重的艰难distinct、group by和内存中去重对比

在查询的字段较少（1-2个），而且条件简单的时候 distinct的性能比group by要高
查询字段多的时候group by 的性能要高，否则group by 性能和distinct的性能相差无几

数据量大的时候在内存中去重的性能无疑是最高的，但是得考虑到内存的消耗问题。可以先查出标识，分好页之后再重新根据标识去查以节省内存

## 查大量的数据真的会影响性能

只查需要的字段会优化一部分性能

## 深分页优化问题

业务优化，不提供跳页查询，只保留上下翻页，
下翻页保留上一次查询的最后一个id，查询下一页的时候将ID加到条件里面可以大大减少数据库扫描的行数，
在数据一致性要求不是很高的时候，上翻页对数据在前端进行缓存，不再提交查询请求

## 尽可能少的关联-不同的条件使用不同的sql

sql尽可能的简单也是优化的必要

## 分库分表

如果单表数据量太大也是很难优化了，所以对数据量大的表进行水平拆分也至关重要，控制单表数据量在500w以内为宜，分库分表方案也不是本文的主题，不再细说
