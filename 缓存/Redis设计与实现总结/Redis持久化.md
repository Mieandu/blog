# Redis有两种持久化策略

## RDB

RDB持久化可以手动执行，也可以自动执行。该功能会将某个时间点的数据持久化到数据库，并生成一个经过压缩的二进制文件。

RDB有两个命令可以用于生成RDB持久化文件:SAVE和BGSAVE

SAVE命令会阻塞Redis服务器进程，直到RDB文件创建完毕，在服务器命令阻塞期间，服务器不能处理任何命令请求。

BGSAVE命令会fork一个子进程，然后由子进程负责创建RDB文件，服务器不会阻塞。

> 我们可以通过`save 时间 修改次数`选项来设置RDB文件的保存频率

RDB文件结构：
|REDIS|db_version|databases|eof|

databases部分：
|selectdb|db_number|key_value_pairs|

key_value_paires:
[|expiretime_ms|ms]|type|key|value|

对于不同的类型，RDB会使用不同的方式保存他们。

## AOF

AOF持久化是通过保存Redis服务器所执行的**写命令**来记录数据库状态的

AOF持久化的3个步骤：命令追加、文件写入、同步

命令追加：当AOF持久化功能开启，服务器在执行完一个写命令之后，会以协议格式，将执行的写命令追加到服务器状态的aof_buf缓冲区的末尾

Reis服务器每次结束一个事件循环之前，都会调用flushAppendOnlyFile函数，考虑是否需要将aof_buf缓冲区的内容写入和保存到AOF文件里面。
>appendfsync选项的值决定写入文件频率：always、everysec、no

AOF重写：

因为AOF持久化是通过保
存被执行的写命令来记录数据库状态的，所以随着服务器运行时间的流逝，AOF
中的内容会越来越多，文件的体积也会越来越大，如果不加以控制的话，体积过大的AOF文件很可能对Redis服务器，甚至整个宿主计算机产生影响，并且AOF体积越大，使用AOF文件来进行数据还原所需的时间就越多。

为了解决AOF文件体积膨胀的问题，Redis提供了AOF文件重写功能。通过该功能，Redis服务器可以创建一个新的AOF文件来替代现有的AOF文件，新旧两个AOF文件所保存的数据库状态相同，但新AOF文件不会包含任何浪费空间的冗余命令，所以新的AOF文件的体积通常会比旧的AOF文件小得多。

虽然Redis将生成新AOF文件替换旧AOF文件得功能命名为“AOF文件重写”，**但实际上，AOF文件重写并不需要对现有AOF文件进行任何读取、分析或者写入操作，这个功能是通过读取服务器当前数据库状态来实现得。
**

## 总结

因为AOF文件的更新频率通常比RDB文件的更新频率高，所以：
如果开启了AOF功能，服务器启动时，会服务器会优先使用AOF来还原数据。
只有AOF持久化功能关闭时，服务器才会使用RDB文件来还原数据。
