# Redis高可用Sentinel和Cluster

## 复制

在Redis中，用户可以通过执行SLAVEOF命令或者设置slaveof选项，让一个服务器去复制另一个服务器，我们称呼被复制的服务器为主服务器，而对主服务器进行复制的服务器则被称为从服务器，进行复制中的主从服务器双方的数据库将保存相同的数据，概念中将这种现象称为“数据库状态一致”。

复制命令 `SLAVEOF master_ip master_port`

### 旧版复制功能实现

Redis的复制功能分为同步（sync）和命令传播（command propagate）两个操作：

- 同步操作用于将从服务器的状态更新至主服务器的状态
- 命令传播操作则用于在主服务器的数据库状态被修改，导致从服务器的数据库状态出现不一致是，让主从服务器的状态重新回到一致。

#### 同步

当客户端向从服务器发送SLAVEOF命令，要求从服务器复制主服务器时，从服务器首先要执行同步操作。

同步操作中，从服务器需要向主服务器发送SYNC命令,SYNC命令的执行步骤如下：
1> 从服务器向主服务器发送SYNC
从服务器向主服务器发送 SYNC 命令。
2> 收到 SYNC 命令的主服务器执行 BGSAVE 四命令，在后台生成一个 RDB  文件 ，并使 用一个缓冲区记录从现在开始执行的所有写  命令。
3> 当主服务器的 BGSAVE 命令执行完毕时 ，主服务器会将 BGSAVE 命令生成的 RDB 文件发送给从服务器 ，从服务器接收并载入这个 RDB 文件，将自己的数据库状态更新至主 服务器执行 BGSAVE 命令时的数据库状态 。
4> 主服务器将记录在缓冲区里面的所有写命令发送给从服务器 ，从服务器执行这些写命令，将自己的数据库状态更新至主服务器数据库当前所处的状态

#### 旧版复制功能的缺陷

对于初次复制来说，旧版复制功能能够很好的完成任务，但对于断线后重复制，旧版复制功能虽然也能完成任务，让主从服务器重新回到一致状态，但效率却非常低（重新生成RDB文件）；命令丢失，主服务器也不会注意到

### 新版复制功能

新版复制（2.8以后），PSYNC命令具有完整重同步和部分重同步两种模式：

- 其中完整重同步用于处理初次复 制情况 ：完整重同步的执行步骤和 SYNC 命令的执 行步骤基本一样 ，它们都是通过让主服务器创建并发送 RDB 文件 ，以及向从服务器 发送保存在缓冲区里面的写命令来进行同步
- 而部分重同步则用于处理断线后重复制情况  ：当从服务器在断线后 重新连接主服务 器时 ，如果条件允许 ，**主服务器可以将主从服务器连接断开期间执行的写命令发送 给从服务器 **，从服务器只要接收并执行这些写命令  ，就可以将数据库更新至主服务 器当前所处的状态。

部分重同步功能由以下三个部分构成 ：

- 主服务器的复制偏移量 （ replication offset ） 和从服务器的复制偏移量 。
- 主服务器的复制积压缓冲区 （ replication backlog ）。
- 服务器的运行 ID ( run ID ）

#### 复制偏移量

通过对比主从服务器的复制偏移量 ，程序可以很容易地知道主从服务器是否处于一致状态 ： 口 如果主从服务器处于一致状态 ，那么主从服务器两者的偏移量总 是相同的。
口 相反 ，如果主从服务器两者的偏移量并不相同 ，那么说明主从服务器并未处于 一致 状态

#### 复制积压缓冲区

复制积压缓冲区是 由主服务器维护的一个**固定长度** （ fixed-size ） 先进先出 （ FIFO ） 队 列 ，默认大小为  I MB

当从服务器重新连上主服务器时 ，从服务器会通过 PSYNC 命令将自己 的复制偏移量 o f f set 发送给主服务器 ，主服务器会根据这个复 制偏移量来决定对从服务器执行何种同步 操作 ：

- 如果 o f f set 偏移量之后的数据 （ 也即是偏移量 o f f set+ l 开始的数据 ） 仍然存在 于复制积压缓冲区里面 ，那么主服务器将对从服务器执行 部分重同步操作 。
- 相反 ，如果 of f set 偏移量之后的数据已经不存在于复制积压缓冲区 ，那么主服务 器将对从服务器执行完整重同步操作 。

> 复制积压缓冲区的最小大小可以根据公式  second * write_size_per_second来估算，稳妥起见应乘以2

#### 服务器运行ID

除了复制偏移量和复制积压缓冲区之外 ，实现部分重同步还需要用到服务器运行 ID ( run lD ) :

- 每个 Red is 服务器 ，不论主服务器还是从服务 ，都会有自己的运行 ID。
- 运行 ID 在服务器启动时自动生成 ，由 40 个随机的十六进制字符组成 ，例如 53b 9b 2 8df 8 0 4 2 f dc 9ab5e3f cbbbab f fld5dce2b3 o
当从服务器对主服务器进行初次复制时 ，主服务器会将自己的 运行 D传送给从服务器 ，
而从服务器则会将这个运行  ID  保存起来。

当从服务器断线并重新连上一个主服务器时 ，从服务器将向当前连接的主服务器发送之 前保存的运行 ID:

- 如果从服务器保存的运行 ID 和当前连接的主服务器的运行 ID 相同 ， 那么说明从服务器断线之前复制的就是当前连接的这个主服务器，主服务器可以继续尝试执行部分重同步操作 。
- 相反地 ，如果从服务器保存的运行 ID 和当前连接的主服务器的运行 ID 并不相同 ， 那么说明从服务器断线之前复制的主服务器并不是当前连接的这个主服务器，主服务器将对从服务器执行完整重同步操作 。

#### PSYNC命令

PSYNC 命令的调用方法有两种 ：

- 如果从服务器以前没有复制过任何主 服务器 ，或者之前执行过 SLAVEOF n o one 命令 ，那么从服务器在开始一次新的复制时将向主服务器发送  PSYNC?    -1 命令 ， 主动请求主服务器进行完整重同步 （ 因为这时不可能执行部分重同步 ）。
- 相反地 ，如果从服务器已经复制过某个主服务器 ，那么从服务器在开始一次新的复 制时将向主服务器发送 PSYNC < r u n id> <offset> 命令 ：其中 ru n id 是上一次 复制的主服务器的运行 ID ，而 of f set 则是从服务器当前的复制偏移量 ，接收到这 个命令的主服务器会通过这两个参数来判断应该对从服务器执行哪种同步操作  。
  
根据情况 ，接收到 PSYNC  命令的主服务器会向从服务器返回 以下三种回复的其中一种：

- 如果主服务器返回 ＋FULLRESYNC < r u n id>  ＜of f set＞ 回复，那么表示主服务
器将与从服务器执行完整重同步操作 ：其中 runid 是这个主服务器的运行 田，从 服务器会将这个 ID 保存起来 ，在下一次发送PSYNC 命令时使用 ；而offset 则是 主服务器当前的复制偏移量 ，从服务器会将这个值作为自己的初始化偏移量。

- 如果主服务器返回 ＋CONTINUE  回复，那么表示主服务器将与从服务器执行部分 重 同步操作，从服务器只要等着主服务器将自己缺少 的那部分数据发送过来就可以了 。
- 如果主服务器返回 ERR 回复，那么表示主服务器的版本低于Redis 2.8 ，它识别不 了 PSYNC 命令 ，从服务器将向主服务器发送SYNC 命令 ，并与主服务器执行完整同 步操作。

#### 复制的完整流程

1. 设置主服务器的地址和端口
2. 建立套接字连接
3. 发送PING命令确认主服务器读写状态是否正常，能否正常处理命令请求
4. 身份验证，从服务器发送 `masterauth <password>` 命令，password和主服务器的 requirepass选项比对
5. 从服务器发送端口信息 `REPLCONF listening-port <port-number>`,向主服务器发送从服务器的监听端口
6. 同步 从服务器将向主服务器发送PSYNC
7. 命令传播

#### 心跳检测

在命令传播阶段，从服务器以每秒一次的频率向主服务器发送命令
`REPLCONF ACK <replication_offset>`

该命令作用如下：

1. 检测主从服务器的网络连接状体
2. 辅助实现min-slaves选项
3. 检测命令丢失

## Sentinel

Sentinel是Redis的高可用解决方案：由一个或多个Sentinel实例组成的Sentinel系统可以监视任意多个主服务器，以及这些主服务器属下的从服务器，当被监视的主服务器进入下线状态时，自动将下线主服务器的某个从服务器升级为新的主服务器，然后由新的主服务器代替已下线的主服务器继续处理命令请求。

## Cluster

## 基于Raft算法的选举
