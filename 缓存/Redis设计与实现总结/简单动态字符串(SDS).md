# 简单动态字符串(SDS)

Redis没有直接使用C语言传统的字符串表示，而是自己构建了一种名为简单动态字符串（Simple Dynamic String，SDS），并将SDS用作Redis的默认字符串表示。

当Redis需要的不仅仅是一个字符串字面量，而是一个可以被修改的字符串值时，就会使用SDS来表示字符串值。

## SDS在Redis中的使用

- 用来保存数据库中的字符串值
- 用作缓冲区
- AOF模块中的AOF缓冲区
- 客户端状态中的输入缓冲区

## SDS的数据结构

## SDS的优点

### 1.常数复杂度获取字符串长度

### 2.杜绝缓冲区溢出

当SDS的API需要对SDS进行修改时，API会先检查SDS的空间是否满足修改所需的要求，如果不满足，API会自动将SDS的空间扩展至执行修改所需的大小

### 3.减少修改字符串长度时所需的内存重分配次数

在C语言中，字符串底层实现是一个N+1个字符长的数组（额外的一个字符空间用于保存空字符），所以每次增长或缩短一个C字符串，程序都总要保存这个C字符串的数组进行一次内存充分配操作

- 如果程序执行的是增长字符串的操作 ，比如拼接操作（ append ），那么在执行这个操 作之前 ，程序需要先通过内存重分配来扩展底层数组的空间大小 一一如果忘了这一步就会产生缓冲区溢出 。
- 如果程序执行的是缩短字符串的操作 ，比如截断操作 （ trim ），那么在执行这个操作 之后 ，程序需要通过 内存重分配来释放字符串不再使用的那部分空间一 一如果忘了 这一步就会产生内存泄漏。
  
因为内存重分配涉及复杂的算法  ，并且可能需要执行系统调用 ，所以它通常是一个比较耗时的操作

为了避免 C 字符串的这种缺陷 ，SDS 通过未使用空间解除了字符串长度和底层数组长度之间的关联 ：在 SDS 中，buf 数组的长度不一定就是字符数量加一 ，数组里面可以包含 未使用的字节 ，而这些字节的数量就由 SDS 的free 属性记录 。

通过未使用空间，SDS 实现了空间预分配和惰性空间释放两种优化策略。

#### 1) 空间预分配

空间预分配用于优化 SDS 的字符串增长操作 ：当 SDS 的 API 对一个 SDS 进行修改 ， 并且需要对 SDS 进行空间扩展的时候 ，程序不仅会为 SDS 分配修改所必须要的空间 ，还会 为 SDS 分配额外的未使用空间。

其中 ，额外分配的未使用空间数量由以下公式决定 ：

- 如果对 SDS 进行修改之后，SDS 的长度（ 也 即是 len 属性的值 ） 将小于 lMB,**那么程序分配和 len 属性同样大小的未使用空间**，这时 SDS len 属性的值将和free属性的值相同 。举个例子 ，如果进行修改之后 ，SDS 的 len 将变成 13 字 节 ，那么程序也会分配 13 字节的未使用空间 ，SDS 的 bu f 数组的实际长度将变成 13+13+ 1=27 字节 （ 额外的一字节用于保存空字符 ）。
- 如果对 SDS 进行修改之后 ，SDS 的长度将大于等于 1MB，那么程序会分配 lMB 的未使用空间。举个例子 ，如果进行修改之后 ，SDS 的 len 将变成 3 0MB，**那么程序会分配 1MB 的未使用空间**，SDS 的 bu f 数组的实
际长度将为 3 0 MB  + lMB  + lbyte

通过空间预分配策略 ，Redis 可以减少连续执行字 符串增长操作所需的内存重分配次数。

#### 1) 惰性空间释放

惰性空间释放用于优化 SDS 的字符串缩短操作 ：当 SDS 的 API 需要缩短 SDS 保存的 字符串时，程序并不立即使用内存重分配来回收缩短后多出来的字节 ，而是使用free 属性 将这些字节的数量记录起来 ，并等待将来使用。

### 4.二进制安全

C 字符串中的字符必须符合某种编码 （ 比如 ASCII ），并且除了字符串的末尾之外 ，字符串里面不能包含空字符 ，否则最先被程序读人的空字符将被误认为是字符串 结尾 ，这些限制使得 C 字符串只能保存文本数据，而不能保存像图片、音频、视频 、压缩文件这样的二进制数据 。

为了确保 Redis 可以适用于各种不同的使用场景 ，SDS  的 API  都是二进制安全的( binary-safe ），所有 SDS API 都会以处理二进制的方式来处理 SDS 存放在 buf数组里的数据 ， 程序不会对其中的数据做任何限制 、过滤、或者假设 ，数据在写入时是什么样的 ，它被读取 时就是什么样。

使用 SDS 来保存之前提到的特殊数据格式就没有任何问题 ，因为 SDS 使用len属性的值而不是空字符来判断字符串是否结束.

### 5.兼容部分C字符串函数

虽然 SDS 的 API 都是二进制安全的 ，但它们一样遵循 C 字符串以空字符结尾的惯例 ： 这些 API 总会将 SDS 保存的数据的末尾设置为空字符 ，并且总会在为 buf 数组分配空间时 多分配一个字节来容纳这个空字符，这是为了让那些保存文本数据的SDS 可以重用一部分< st r in g .h＞ 库定义的函数
